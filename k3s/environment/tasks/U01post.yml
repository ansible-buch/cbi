---
- name: Create Bash completion plugin dir
  file:
    path: /etc/bash_completion.d
    state: directory

- name: Create kubectl completions
  shell:
    cmd: "kubectl completion bash >/etc/bash_completion.d/kubectl"
    creates: /etc/bash_completion.d/kubectl


# - name: Grant ACL read access to global kubeconfig file
#   ansible.posix.acl:
#     path: /etc/rancher/k3s/k3s.yaml
#     entity: "{{user}}"
#     etype: user
#     permissions: r
#     state: present
    
- name: Create ~/.kube dir
  file:
    path: ~{{item}}/.kube
    state: directory
    mode: 0700
    owner: "{{item}}"
    group: "{{lookup('pipe', 'id -gn ' + item)}}"
  with_items:
    - root
    - "{{user}}"

- name: Create symlinks to global kubeconfig (due to helm)
  file:
    state: link
    follow: false
    src: /etc/rancher/k3s/k3s.yaml
    dest: ~{{item}}/.kube/config
    owner: "{{item}}"
    group: "{{lookup('pipe', 'id -gn ' + item)}}"
  with_items:
    - root
    - "{{user}}"
